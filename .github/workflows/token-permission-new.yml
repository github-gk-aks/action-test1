name: Check and Add Permissions Block

on:
  workflow_dispatch:

jobs:      
  add-permissions-block:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
       token: ${{ secrets.GK_PAT }}

    - name: Find YML Files
      id: find-yml
      run: |
        file_list=$(find .github/workflows -type f -name "*.yml" -not -name 'token-permission.yml' -printf '%p,' | sed 's/,$//')
        file_list="[\"$(echo "$file_list" | sed 's/,/\",\"/g')\"]"
        echo "File List: $file_list"
        echo "::set-output name=file-list::$file_list"

    - name: Check and Add Permissions Block
      run: |
        file_list="${{ steps.find-yml.outputs.file-list }}"
        for file_path in $file_list; do
        if ! grep -q "permissions:" "$file_path"; then
            echo "Permissions block not found in $file_path. Adding..."
            sed -i -e '/^jobs:/i \permissions: write-all\n' "$file_path"
        else
            echo "Permissions block found in $file_path. Skipping..."
        fi
        done

    - name: Check for Changes
      id: check_changes
      run: |
        if git diff --quiet; then
        echo "No changes to commit. Skipping commit step."
        echo "::set-output name=changes::false"
        else
        echo "::set-output name=changes::true"
        fi
      shell: bash

    - name: Commit Changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config user.email ${{ secrets.GIT_COMMITTER_EMAIL }}
        git config user.name ${{ secrets.GIT_COMMITTER_NAME }}
        git add .
        git commit -m "Added Permission Block- $(date +"%Y-%m-%d %H:%M:%S")"
        git push # Replace 'branch-name' with the branch name
      env:
        GITHUB_WORKSPACE: ${{ github.workspace }}
        GITHUB_TOKEN: ${{ secrets.GK_PAT }}


